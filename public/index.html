<!DOCTYPE html>
<html>
<head>
  <title>A/B Testing Interface</title>
  <style>
    /* Add necessary styles */
    #screenshot {
      display: none;
    }
  </style>
</head>
<body>
  <h1>A/B Testing Interface</h1>
  <form id="urlForm">
    <label for="urlInput">Enter URL:</label>
    <input type="text" id="urlInput" required>
    <button type="submit">Load Screenshot</button>
  </form>
  <img id="screenshot" />
  <div id="stylingForm">
    <h2>Styling Options</h2>
    <label for="styleSelect">Select Style:</label>
    <select id="styleSelect">
      <option value="backgroundColor">Background Color</option>
      <option value="color">Color</option>
      <option value="borderRadius">Border Radius</option>
    </select>
    <label for="hexInput">Enter Hex Code:</label>
    <input type="text" id="hexInput">
    <button id="applyStylingBtn">Apply Styling</button>
  </div>
  <div id="successMessage" style="display: none;">Styling changes applied successfully!</div>
  <iframe id="live-external-site" style="display: none;"></iframe>

  <script>
    let selectedElementPath;

    // Capture the screenshot of the entered URL
    async function captureScreenshot(event) {
      event.preventDefault();

      const url = document.getElementById('urlInput').value;
      const response = await fetch('/get-screenshot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const { screenshot } = await response.json();

      const screenshotImg = document.getElementById('screenshot');
      screenshotImg.src = 'data:image/png;base64,' + screenshot;
      screenshotImg.style.display = 'block';

      // Fetch overlay HTML
      const overlayResponse = await fetch('/get-overlay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const { html } = await overlayResponse.json();

      // Create a div to contain the overlay
      const overlayDiv = document.createElement('div');
      overlayDiv.innerHTML = html;
      overlayDiv.style.position = 'absolute';
      overlayDiv.style.width = '100%';
      overlayDiv.style.height = '100%';
      overlayDiv.style.top = '0';
      overlayDiv.style.left = '0';
      overlayDiv.style.pointerEvents = 'none';

      // Add the overlay to the body
      document.body.appendChild(overlayDiv);

      overlayDiv.addEventListener('click', function(event) {
        selectedElementPath = event.path.map(element => element.tagName).join(' > ');
      });
    }

    // Handle element selection and apply styling changes
    async function applyStyling() {
      const styleSelect = document.getElementById('styleSelect');
      const selectedStyle = styleSelect.value;
      const hexInput = document.getElementById('hexInput');
      const hexCode = hexInput.value;

      const response = await fetch('/update-styling', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: document.getElementById('urlInput').value, elementPath: selectedElementPath, style: selectedStyle, value: hexCode })
      });

      if (response.ok) {
        const iframe = document.getElementById('live-external-site');
        iframe.contentWindow.postMessage({
          type: 'stylingChange',
          elementPath: selectedElementPath,
          style: selectedStyle,
          value: hexCode,
        }, '*');

        // Optional: Display a success message
        const successMessage = document.getElementById('successMessage');
        successMessage.style.display = 'block';
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 3000);
      }
    }

    // Add an event listener to the form submission
    document.getElementById('urlForm').addEventListener('submit', captureScreenshot);

    // Add an event listener to the Apply Styling button
    document.getElementById('applyStylingBtn').addEventListener('click', applyStyling);
  </script>
</body>
</html>
